name: Auto-Generate Documentation

on:
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'docs/**'
      - '.github/workflows/docs-auto-generate.yml'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Generation mode'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff detection

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install documentation tools
        run: |
          go install golang.org/x/tools/cmd/godoc@latest
          go install github.com/swaggo/swag/cmd/swag@latest

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event.inputs.mode }}" = "full" ] || [ ! -f docs/api-reference.html ]; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "Running FULL documentation generation"
          else
            # Check if Go files changed
            CHANGED_GO=$(git diff --name-only HEAD~1 HEAD | grep '\.go$' || true)
            if [ -n "$CHANGED_GO" ]; then
              echo "mode=incremental" >> $GITHUB_OUTPUT
              echo "Go files changed, running INCREMENTAL update"
            else
              echo "mode=skip" >> $GITHUB_OUTPUT
              echo "No Go files changed, skipping"
            fi
          fi

      - name: Generate static Go documentation
        if: steps.changes.outputs.mode != 'skip'
        run: |
          # Generate godoc HTML
          mkdir -p docs/static/godoc

          # Run godoc server in background
          godoc -http=:6060 &
          GODOC_PID=$!

          # Wait for server to start
          sleep 3

          # Fetch HTML pages for each package
          for pkg in $(go list ./...); do
            pkg_path=$(echo $pkg | sed 's|aurumcode/||')
            mkdir -p "docs/static/godoc/$pkg_path"
            wget -q "http://localhost:6060/pkg/$pkg" -O "docs/static/godoc/${pkg_path}.html" || true
          done

          # Kill godoc server
          kill $GODOC_PID

      - name: Generate CHANGELOG
        if: steps.changes.outputs.mode != 'skip'
        run: |
          chmod +x generate-docs-simple.sh
          ./generate-docs-simple.sh

      - name: Generate enhanced documentation with LLM
        if: steps.changes.outputs.mode != 'skip'
        env:
          TOTVS_DTA_API_KEY: ${{ secrets.TOTVS_DTA_API_KEY }}
          TOTVS_DTA_BASE_URL: ${{ secrets.TOTVS_DTA_BASE_URL }}
        run: |
          chmod +x scripts/generate-enhanced-docs.sh
          ./scripts/generate-enhanced-docs.sh ${{ steps.changes.outputs.mode }}

      - name: Build documentation site
        if: steps.changes.outputs.mode != 'skip'
        run: |
          chmod +x scripts/build-docs-site.sh
          ./scripts/build-docs-site.sh

      - name: Deploy to GitHub Pages
        if: steps.changes.outputs.mode != 'skip'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/public
          publish_branch: gh-pages
          force_orphan: true

      - name: Commit generated docs to main
        if: steps.changes.outputs.mode != 'skip'
        run: |
          git config user.name "AurumCode Bot"
          git config user.email "bot@aurumcode.dev"

          git add docs/ CHANGELOG.md README.md

          if git diff --staged --quiet; then
            echo "No documentation changes to commit"
          else
            git commit -m "docs: Auto-generate documentation [skip ci]

Generated by GitHub Actions workflow
Mode: ${{ steps.changes.outputs.mode }}
Commit: ${{ github.sha }}

ðŸ¤– Automated by AurumCode"
            git push
          fi
